# 레이스 컨디션  

## 레이스 컨디션 공격에 대한 이해  

### 레이스 컨디션 공격의 기본 아이디어  
- 일종의 바꿔치기.
- 관리자의 권한으로 실행되는 프로그램 중간에 끼어들어 자신이 원하는 작업을 하는 것. 
- 타이밍이 중요  
- 실질적인 공격 원리  
  - 어떤 프로그램은 실행 도중에 임시 파일을 생성해 사용  
  - 임시 파일 생성 후 그 파일에 접근하는 아주 짧은 시간 동안 끼어들 여유가 생기게 됨  
  - 이 틈을 이용  
  
### 파일 링크  

#### 하드 링크  
- 똑같이 복사된 파일을 만드는 것.
- 하드 링크의 생성  
  - a.txt 파일을 관리자 소유로 /root 디렉터리에 만든다. `ls -al /root/a.txt`  
  - 하드 링크를 할 때는 다음과 같이 다른 옵션 없이 두 파일을 ln(link) 명령어로 연결. 연결 뒤 링크한 파일의 링크 수가 2로 증가되었음을 확인할 수 있다.  
  - `ln /root/a.txt /wishfree/race/link.txt`  
  - 링크된 link.txt 파일을 확인해 보면 /root/a.txt 파일과 내용이 똑같음을 알 수 있다.  
- 하드 링크된 파일을 수정하면 원래 파일도 똑같이 수정되고  
- 두 파일 중 하나를 삭제하면 파일의 내용은 바뀌지 않고 링크의 숫자만 하나 줄어든다.  
- 즉, 하드 링크에서는 두 파일이 각각 동일한 수준의 데이터를 가지며 서로 그 데이터를 동기화한다.  
- 링크하고자 하는 파일이 다른 파티션에 존재하면 안 된다.  

#### 심볼릭 링크  
- 레이스 컨디션 공격에 쓰임  
- 하드 링크와 달리 실제 두 파일을 생성해 링크하지 않는다.  
- 데이터가 있는 파일이 처음부터 하나 뿐. 심볼릭 링크는 단지 원본 파일 데이터를 가리키는 링크 정보만을 가진다.  
- 심볼릭 링크의 생성  
  - 심볼릭 링크는 ln 명령에 '-s' 옵션을 이용  
  - 하드 링크와 달리 링크 수가 2로 변하지 않으며 링크된 파일의 정보만 표시됨  
  - `ln -s /root/a.txt /wishfree/race/symlink.txt`  
- 윈도우에서의 단축 아이콘과 비슷한 개념. 단축 아이콘이 원본 파일이 삭제되어도 그대로 남아있지만 실행되지 안흔 것과 같다.  

### 심볼릭 링크와 레이스 컨디션 공격  
- 레이스 컨디션 공격의 대상은 소유자가 root고, SetUID 비트를 가지며, 임시 파일을 생성하는 파일  
- 정상적인 경우 다음과 같은 처리 프로세스를 거침  
- 일반 권한: 프로그램 실행 → SetUID로 인한 프로세스 권한 상승. 관리자 권한: → 임시 파일 생성 → 프로그램 동작 및 임시 파일 처리 → 프로그램 종료  
- 생성되는 임시 파일의 이름을 알고 있어야 한다.  

- 리눅스의 `lsof`(list open files)라는 명령어로 특정 파일에 접근하는 프로세스 목록을 확인 가능  
- ssh 데몬의 프로세스 아이디를 확인  
  - `ps -ef | grep ssh`  
- lsof 명령으로 프로세스 아이디가 1165번인 프로세스가 사용하는 파일 목록 확인  
  - `lsof -p 1165`  
- 생성된 임시 파일을 확인 후 임시 파일 이름으로 프로그램이 실행되기 전 심볼릭 링크 파일을 생성 가능  
- 더불어 해당 심볼릭 링크 파일은 관리자 권한으로만 접근 가능한 /etc/passwd 파일 등을 가리키고 있게 됨.  
![6-22](https://cloud.githubusercontent.com/assets/6129764/11714907/dd5a6e20-9f80-11e5-863e-8f99431b51de.jpg)  
**프로그램 실행 전 임시 파일을 심볼릭 링크로 미리 생성**  
- 프로그램이 임시 파일을 사용하기 위해 생성하기 전 해당 임시 파일이 이미 존재하고 있는지 여부를 판단하지 않는다면 프로그램은 다음과 같이 실행  
![6-19](https://cloud.githubusercontent.com/assets/6129764/11714741/9e344a28-9f7f-11e5-91ec-62c4007e0026.jpg)  
**임시 파일이 심볼릭 링크 파일로 교체된 후 프로그램 실행 절차** 
- 임시 파일을 생성하는 프로그램 들 → 임시 파일 생성 전에 임시 파일의 존재 여부를 확인. 존재할 경우 파일을 지우고 재생성.  
  1. 임시 파일 존재 여부 확인  
  2. 임시 파일이 있다면 삭제하고 재생성  
  3. 임시 파일에 접근하고 처리  
- 레이스 컨디션 공격 코드는 다음과 같은 작업을 반복적으로 수행  
  1. 임시 파일이 존재하는 경우 심볼릭 링크 파일인지 여부 확인  
  2. 심볼릭 링크가 안리 경우 임시 파일을 삭제  
  3. 임시 파일을 심볼릭 링크로 생성  
- 레이스 컨디션 공격 성공한 경우  
  - 정상 프로세스 - 1. 임시 파일 존재 여부 확인  
  - 정상 프로세스 - 2. 임시 파일이 이미 있다면 삭제하고 재생성  
  - 공격 프로세스 - 1. 임시 파일이 존재하는 경우 심볼릭 링크 파일인지 확인  
  - 공격 프로세스 - 2. 심볼릭 링크가 아닐 경우 임시 파일을 삭제  
  - 공격 프로세스 - 3. 임시 파일을 심볼릭 링크로 생성  
  - 정상 프로세스 - 3. 임시 파일에 접근하고 처리  

### 레이스 컨디션 공격의 다른 경우  

- 프로그램이 생성하고 사용하는 임시 파일에 우리가 알고자 하는 중요한 정보가 담겨 있다면, 그 정보를 획득하기 위해 어떤 레이스 컨디션을 만들어야 할까?  
- 예) 어떤 프로그램이 중요한 데이터를 암호화하여 가지고 있고, 프로그램 실행 전에 암호화된 파일을 복호화한 뒤 메모리에 로드하고 복호화된 임시 파일을 삭제한다고 가정  
- 정상적인 프로그램 실행 과정  
  - 프로그램 실행 → 암호화된 파일 접근 → 복호화된 임시 파일 생성 → 메모리 업로드 후 임시 파일 삭제 → 프로세스 처리 → 프로그램 종료   
- 이 때, 레이스 컨디션으로 수행할 프로세스  
  - 복호화된 임시 파일 접근 → 다른 파일명으로 복사  
- 레이스 컨디션 공격 성공 시 프로그램 프로세스  
![6-30](https://cloud.githubusercontent.com/assets/6129764/11715076/56087fb4-9f82-11e5-93ac-4cb5872af36f.jpg)  
