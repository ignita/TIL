# 리버스 엔지니어링

## 리버스 엔지니어링에 대한 이해 
- **역공학(逆工學)**. 장치나 시스템의 구조를 분석해 원리를 발견하는 과정
- 상업적이나 군사적으로 하드웨어를 분석하는 것에서 시작됨.
- 목적: 어떤 대상을 생산하기 위한 지식이나 절차가 거의 없는 상태에서 **최종 제품을 통해 설계하는 과정을 역추론** 하는 것 
- 예) 자체 기술이 부족한 상황에서 자동차 생산을 위해 수입한 외국 명차를 모두 분해하고 재조립하는 과정을 반복했었음.

### 적용 사례
- 이미 만들어진 프로그램의 동작 원리를 이해하고 유사한 프로그램을 만들기 위해 리버스 엔지니어링을 이용  
- 프로그램의 보안 문제, 동작 문제, 오류 등을 이용하거나 제품 출시 전 그런 문제점과 오류를 제거, 검토하기 위해 리버스 엔지니어링을 이용  
- 리버스 엔지니어링을 이용해 바이러스(또는 웜)를 만들거나 백신을 만든다.  

**→ 리버스 엔지니어링의 핵심은 프로그램의 동작 원리를 이해하는 것**  


## PE 파일에 대한 이해  

### PE 파일의 기본 구조 
- PE 파일 형식(Portable Executable File Format)은 1993년 MS에서 표준안을 만든 것으로, 메모리에서도 디스크에 저장된 파일 형태로 바로 실행될 수 있도록 설계되었다.  
- 형식은 Win32의 기본 파일 형식(윈도우에서 실행되는 프로그램은 모두 해당됨)  
- 예) EXE 파일(실행 파일), 동적 링크 라이브러리(DLL, Dynamic Linking Library)파일  
- 윈도우에서 동작하는 프로그램을 이해하는데 매우 중요. 리버스 엔지니어링에서도 매우 많은 도움이 됨.

**PE 파일 구조**  
![PE파일](http://cfile1.uf.tistory.com/image/26426943530B620E0FA365)

### 헤더
#### DOS 헤더
- PE 파일은 DOS 헤더로 시작(DOS와 호환하기 위해 사용)  
- 항상 크기가 64바이트  
- DOS 헤더의 마지막 'File address of new exe header' = e_lfanew = PE 헤더의 주소 값이 적혀있음 

#### PE 헤더  
- PE 파일의 구성 정보를 가짐  
- PE 파일에서는 데이터 특성별로 **섹션**으로 구분해 저장 
- 해당 PE 파일이 가지는 섹션 개수나 파일 속성, 섹션 헤더의 크기를 비롯해 이미지 베이스(Image Base), 엔트리 포인트(Entry Point) 주소, 메모리상의 각 섹션이 차지하는 크기, 디스크 상에서의 섹션 정렬, PE 파일의 총 크기, 디스크상에서의 헤더의 총 크기 등과 같은 **정보**를 모두 담고 있다.  

### 섹션 테이블  
- 섹션: 성질이 동일한 데이터가 저장되어 있는 영역 → 윈도우에서 사용하는 메모리 보호 메커니즘과 연관  
- 파일에 존재하는 섹션을 메모리에 로드하기 위한 정보의 배열  

### 섹션
- 동일한 성질의 데이터가 저장되어 있는 영역, 실질적인 정보와 데이터, 실행 코드 등...  

### 리버스 엔지니어링에 대한 대응책  
- 상품으로 프로그램을 내놓은 사람의 입장: 자신의 프로그램이 노출되어 유용되거나 악용될 수 있음.
- 악성 코드를 만드는 사람의 입장: 자신의 악성 코드를 무력화하는 백신을 만들 수 있음. 
- → 리버스 엔지니어링을 어렵게 만드는 기술을 개발해 프로그램에 적용 
- 안티 리버싱(Anti-Reversing): 리버스 엔지니어링을 어렵게 만드는 기술  

#### 패킹
- 패킹(Packing)은 원본 프로그램을 새로운 PE 파일에 패킹된 형태로 압축하고 암호화하여 저장하는 기술  
![packing](http://cfs4.tistory.com/upload_control/download.blog?fhandle=YmxvZzU2NDM3QGZzNC50aXN0b3J5LmNvbTovYXR0YWNoLzAvMTIuanBn)  
- 패킹된 프로그램은 프로그램이 정상적으로 실행될 수 있도록 복호화하고 압축을 풀어내는 로직도 포함  
- 패킹된 프로그램을 분석하려면 언팩킹한 후 분석  

#### 안티 디버깅  
- 리버스 엔지니어링을 수행하기 위해서는 <kbd>F2</Kbd> 토글 키를 이용해 브레이크 포인트를 설정, <kbd>F7</kbd>을 이용해 한 단계씩 실행해 분석하는 디버깅 과정을 거침  
- 안티 디버거는 이렇게 수행되는 디버거의 활동을 여러 가지 방법으로 탐지해 프로그램을 강제 종료  

#### 타이밍 체크  
- 프로세스가 디버깅 중일 때 cpu 연산 시간이 정상적으로 실행되었을 때보다 많이 걸린다는 점에서 착안   
- RDTSC(Read Time-Stamp Counter) 명령을 써서 두 구간 상의 타임 스탬프(Time Stemp) 값을 비교한다.  
- 시간이 많이 걸리는 특정 구간을 디버깅 중으로 판단해 프로그램이나 디버거를 종료  

#### 쓰레기 코드 넣기와 코드 치환  
- 코드 사이에 의미 없는 쓰레기(Garbage Code) 코드를 넣고, 다단계의 점프 문을 섞어 코드를 치환(Permutation)하여 배치하는 방법  
- 리버서로 하여금 해당 코드를 따라가다 지치게 만든다. 

