# TCP의 이해  

## 전송 계층의 기능  

- 전송 계층 프로토콜은 오류 제어, 흐름 제어, 데이터 순서화 등의 기능면에서 데이터 링크 계층과 특징이 유사.  
- 데이터 링크 계층: 물리적인 전송 선로로 직접 연결된 두 물리적 호스트(컴퓨터나 라우터) 사이의 데이터 전송을 담당  
- 전송 계층: 네트워크 끝단에 위치하는 통신 주체가 중간의 논리적 선로(라우터로 연결도니 컴퓨터 네트워크)를 통해 데이터를 주고받음.  

### 전송 계층의 주요 기능  

#### 흐름 제어  
- 전송 계층의 서비스를 이용해 연결을 설정 → 양 끝단의 호스트에서 실행되는 프로세스가 데이터를 주고 받을 수 있다.  
- 이 과정에서 필요한 기능 중 하나가 흐름 제어(Flow Control)  
- 수신자가 송신자의 전송 속도보다 느리게 데이터를 수신하면 버퍼 용량이 초과되 데이터를 분실할 수 있음  
  - 이 경우 타임아웃 기능을 통해 재전송 과정을 수행 → 전체 네트워크 전송 효율이 점점 늦어짐.  
  - 흐름 제어 기능은 수신자가 슬라이딩 윈도우 프로토콜의 윈도우 하단 값을 조정한다. (송신자가 보낼 수 있는 패킷의 한계를 지정)  

#### 오류 제어  
- 데이터를 전송하는 과정에서 발생할 수 있는 오류: 데이터 변형, 데이터 분실  
- 전송 오류의 발생에 따라 수신 데이터의 내용이 깨지거나 분실되면 데이터 재전송에 의한 오류 제어(Error Control)기능에 의해 복구 절차가 진행  
- 예) 전송 데이터를 특정 목적지까지 라우팅하는 과정에서 네트워크 계층의 기능적 한계나 잘못된 목적지 호스트의 위치 정보에 의해 올바르게 전달되지 않을 수 있음.  

#### 분할과 병합  
- 상위 계층에서 전송을 요구한 데이터 크기가 전송 계층에서 처리할 수 있는 데이터 크기보다 크면 데이터를 쪼개 전송해야 함.  
- 데이터를 전송하기 전에 적합한 크기로 나누는 과정을 **분할(Segmentation)**  
- 수신 측에서 수신한 데이터를 원래 크기로 다시 모으는 과정을 **병합(Reassembly)**  

#### 서비스 프리미티브  
- 전송 계층 사용자가 전송 계층 서비스를 사용하기 위한 인터페이스  
- 네트워크 계층에서 제공하는 서비스는 일반적으로 비신뢰성을 바탕으로한 비연결형 서비스 프리미티브가 정의됨.  
- 신뢰성이 향상도니 연결형 서비스도 제공  

### 전송 계층 설계 시 고려 사항  
#### 멀티플렉싱  
- 개별적으로 설정도니 전송 계층 연결에서 전송 데이터 단위인 TPDU(Transport Protocol Data Unit)의 목적지가 동일한 호스트면 이들 데이터를 하나의 가상 회선에 실어 전송하는 것이 유리할 수 있다.  
- **멀티플렉싱(Multiplexing)의 종류**
![멀티플렉싱](http://dbscthumb.phinf.naver.net/3578_000_1/20141023224420308_ERJG8I4I5.jpg/ka8_125_i1.jpg?type=w575_fst&wm=N)  
  - 상방향 멀티플렉싱  
    - 다수의 전송 계층 연결에 대해 하부의 네트워크 계층에서 연결이 하나 형성  
    - 여러 전송 계층의 연결에서 발생한 데이터가 동일한 송수신 호스트의 경로로 전송되면 하나의 네트워크 연결에 묶어 전송이 가능  
    - 일반적인 연결 구조보다 가상 회선 연결의 개수를 줄일 수 있으므로 연결 설정에 걸리는 시간이 단축  
  - 하방향 멀티플렉싱  
    - 하나의 전송 연결을 의미하는 포트에 다수의 가상 회선을 할당  
    - 전송 속도뿐만 아니라, 전송 계층에서 발생하는 데이터의 특성에 따라 개별 가상 회선을 할당함으로써 효과적인 통신이 가능  
    - 예) 전송 연결에서 송신하고자 하는 데이터의 종류가 영화 파일이라면, 그 내용을 영상, 음성, 모국어 자막, 외국어 자막 정보 등으로 구분해 네트워크 연결을 개별적으로 설정이 가능  


## TCP  

- TCP(Transpot Control Protocol)는 IP 프로토콜 위에서 연결형 서비스를 지원하는 전송 계층 프로토콜. 
- 인터넷 환경에서 기본으로 사용  
- 주요 기능  
  - 연결형 서비스를 제공  
  - 전이중(Full Duplex)방식의 양방향 가상 회선을 제공  
  - 신뢰성 있는 데이터 전송을 보장  
- 데이터를 세그먼트(Segment)라는 블록 단위로 분할해 전송  
- 세그먼트를 하나의 단위로 간주해 순서 번호를 관리하지 않는다. 대신 세그먼트에 실려 전송되는 데이터의 바이트 개수를 순서 번호에 반영  

### 포트 번호  
- 포트(Port) 번호는 TCP와 UDP가 상위 계층에 제공하는 주소 표현 방식  
- 유닉스 환경에서는 소켓으로 포트를 구현하므로 소켓 시스템 콜의 인터페이스를 알아야함.  
- 클라이언트-서버의 연동은 서버가 먼저 실행, 클라이언트가 서버와 연결을 시도하는 방법으로 이루어짐.  
  - 이때 연결을 원하는 서버와 접속하려면 서버의 IP 주소와 포트 번호를 알아야한다.  
- 인터넷 환경에서 많이 사용하는 네트워크 응용 서비스의 서버 프로세스에 할당된 포트 번호를 **Well-known 포트**라고 한다.  
  - 전 세계 모든 컴퓨터가 동일한 포트 번호를 사용하도록 권고  
  ![well-known 포트](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTBHGHS7BA9cwbSosjQzlaUoYyrV4sYOkl_2Rho5dtcS--tyKJ8)  
  
## TCP의 데이터 전송  
- 전이중 방식의 양방향 통신을 지원. 가상 회선으로 연결된 두 프로세스가 동시에 데이터 전송 가능  
- 따라서 전송 데이터와 응답 데이터를 함께 전송하는 피기배킹(Piggybacking) 기능을 사용   
![tcp 연결 설정](http://dbscthumb.phinf.naver.net/3578_000_1/20141023224430299_83MO1KPU6.jpg/ka8_130_i1.jpg?type=w383_fst_n&wm=Y)  
먼저 A 프로세스는 TCP 헤더의 SYN 플래그를 지정한 세그먼트를 전송함으로써 연결 설정을 요구한다. 순서 번호 10번은 임의로 설정한 것이다. 연결 설정 요구를 받은 B 프로세스가 연결을 수락하려면 이에 대한 긍정 응답을 해야 한다. 이를 위해 SYN과 ACK 플래그를 지정해 연결에 대한 긍정 응답을 표시하였다. SYN 플래그가 지정한 세그먼트에는 전송 데이터가 포함되지 않지만 순서 번호는 1이 증가한다. 따라서 SYN 세그먼트의 순서 번호 10에 1을 더한 11번을 Acknowledgment Number 필드에 지정해 회신해야 한다. Acknowledgement Number 값을 유효하게 하기 위해 ACK 플래그를 지정했으며, B 프로세스의 순서 번호 50번은 임의로 지정하였다.  

마지막에 있는 세 번째 세그먼트는 B 프로세스가 전송한 연결 수락 세그먼트가 제대로 도착 했음을 알린다. [그림 9-10]은 A 프로세스가 전송할 데이터가 없을 때 처리하는 방식이고, 전송 데이터가 있으면 세 번째 세그먼트에서 바로 데이터를 전송해도 된다.  

- TCP는 부정 응답인 NAK를 사용하지 않고, 수신 프로세스가 응답하지 않으면 데이터 분실과 동일하게 처리된다. 타임아웃 기능으로 복구  
- 해제는 FIN 플래그를 지정해 요구  


## 요약  
1. 전송 계층은 프로세스 간의 가상 회선 연결을 지원하며, 흐름 제어, 오류 제어, 데이터 분할과 병합 등의 기능을 제공한다.
2. 전송 계층 프로토콜을 설계할 때는 프로세스에 대한 주소 표현, 멀티플렉싱, 연결 설정·해제를 고려해야 한다.

3. 연결 해제는 한쪽 프로세스의 일방적인 선언에 의해 이루어지거나 두 프로세스의 합의로 이루어진다.

4. TCP는 전이중 방식의 신뢰성 있는 양방향 통신을 지원하는 연결형 서비스를 제공한다.

5. TCP 세그먼트에는 상위 계층에서 내려온 정보가 포함되며, TCP 세그먼트는 IP 프로토콜 구조의 데이터에 포함되어 전송된다.

6. 인터넷에서 많이 사용하는 네트워크 응용 서비스는 Well-known 포트라는 고정된 포트 주소를 갖는다.

7. TCP의 연결 설정은 SYN 플래그를 이용해 3단계 설정 방식으로 이루어진다.

8. TCP에서는 NAK 프레임을 지원하지 않기 때문에 세그먼트 분실과 세그먼트 변형이 동일하게 취급되어 송신자의 타임아웃 기능을 통해 재전송된다.

9. TCP의 연결 해제는 양쪽 프로세스가 모두 FIN 플래그를 전송함으로써 완결된다.


